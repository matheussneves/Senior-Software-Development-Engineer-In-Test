"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.deepFreeze = deepFreeze;
exports.getObjectId = getObjectId;
exports.getObjectSize = getObjectSize;
exports.requirePackage = requirePackage;

require("source-map-support/register");

var _system = require("./system");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _uuid = require("uuid");

const ECMA_SIZES = Object.freeze({
  STRING: 2,
  BOOLEAN: 4,
  NUMBER: 8
});

async function linkGlobalPackage(packageName) {
  try {
    _logger.default.debug(`Linking package '${packageName}'`);

    const cmd = (0, _system.isWindows)() ? 'npm.cmd' : 'npm';
    await (0, _teen_process.exec)(cmd, ['link', packageName], {
      timeout: 20000
    });
  } catch (err) {
    const msg = `Unable to load package '${packageName}', linking failed: ${err.message}`;

    _logger.default.debug(msg);

    if (err.stderr) {
      _logger.default.debug(err.stderr);
    }

    throw new Error(msg);
  }
}

async function requirePackage(packageName) {
  try {
    _logger.default.debug(`Loading local package '${packageName}'`);

    return require(packageName);
  } catch (err) {
    _logger.default.debug(`Failed to load local package '${packageName}': ${err.message}`);
  }

  try {
    const globalPackageName = _path.default.resolve(process.env.npm_config_prefix ?? '', 'lib', 'node_modules', packageName);

    _logger.default.debug(`Loading global package '${globalPackageName}'`);

    return require(globalPackageName);
  } catch (err) {
    _logger.default.debug(`Failed to load global package '${packageName}': ${err.message}`);
  }

  try {
    await linkGlobalPackage(packageName);

    _logger.default.debug(`Retrying load of linked package '${packageName}'`);

    return require(packageName);
  } catch (err) {
    _logger.default.errorAndThrow(`Unable to load package '${packageName}': ${err.message}`);
  }
}

function extractAllProperties(obj) {
  const stringProperties = [];

  for (const prop in obj) {
    stringProperties.push(prop);
  }

  if (_lodash.default.isFunction(Object.getOwnPropertySymbols)) {
    stringProperties.push(...Object.getOwnPropertySymbols(obj));
  }

  return stringProperties;
}

function _getSizeOfObject(seen, object) {
  if (_lodash.default.isNil(object)) {
    return 0;
  }

  let bytes = 0;
  const properties = extractAllProperties(object);

  for (const key of properties) {
    if (typeof object[key] === 'object' && !_lodash.default.isNil(object[key])) {
      if (seen.has(object[key])) {
        continue;
      }

      seen.add(object[key]);
    }

    bytes += getCalculator(seen)(key);

    try {
      bytes += getCalculator(seen)(object[key]);
    } catch (ex) {
      if (ex instanceof RangeError) {
        bytes = 0;
      }
    }
  }

  return bytes;
}

function getCalculator(seen) {
  return function calculator(obj) {
    if (_lodash.default.isBuffer(obj)) {
      return obj.length;
    }

    switch (typeof obj) {
      case 'string':
        return obj.length * ECMA_SIZES.STRING;

      case 'boolean':
        return ECMA_SIZES.BOOLEAN;

      case 'number':
        return ECMA_SIZES.NUMBER;

      case 'symbol':
        return _lodash.default.isFunction(Symbol.keyFor) && Symbol.keyFor(obj) ? Symbol.keyFor(obj).length * ECMA_SIZES.STRING : (obj.toString().length - 8) * ECMA_SIZES.STRING;

      case 'object':
        return _lodash.default.isArray(obj) ? obj.map(getCalculator(seen)).reduce((acc, curr) => acc + curr, 0) : _getSizeOfObject(seen, obj);

      default:
        return 0;
    }
  };
}

function getObjectSize(obj) {
  return getCalculator(new WeakSet())(obj);
}

const OBJECTS_MAPPING = new WeakMap();

function getObjectId(object) {
  if (!OBJECTS_MAPPING.has(object)) {
    OBJECTS_MAPPING.set(object, (0, _uuid.v4)());
  }

  return OBJECTS_MAPPING.get(object);
}

function deepFreeze(object) {
  let propNames;

  try {
    propNames = Object.getOwnPropertyNames(object);
  } catch (ign) {
    return object;
  }

  for (const name of propNames) {
    const value = object[name];

    if (value && typeof value === 'object') {
      deepFreeze(value);
    }
  }

  return Object.freeze(object);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFQ01BX1NJWkVTIiwiT2JqZWN0IiwiZnJlZXplIiwiU1RSSU5HIiwiQk9PTEVBTiIsIk5VTUJFUiIsImxpbmtHbG9iYWxQYWNrYWdlIiwicGFja2FnZU5hbWUiLCJsb2ciLCJkZWJ1ZyIsImNtZCIsImlzV2luZG93cyIsImV4ZWMiLCJ0aW1lb3V0IiwiZXJyIiwibXNnIiwibWVzc2FnZSIsInN0ZGVyciIsIkVycm9yIiwicmVxdWlyZVBhY2thZ2UiLCJyZXF1aXJlIiwiZ2xvYmFsUGFja2FnZU5hbWUiLCJwYXRoIiwicmVzb2x2ZSIsInByb2Nlc3MiLCJlbnYiLCJucG1fY29uZmlnX3ByZWZpeCIsImVycm9yQW5kVGhyb3ciLCJleHRyYWN0QWxsUHJvcGVydGllcyIsIm9iaiIsInN0cmluZ1Byb3BlcnRpZXMiLCJwcm9wIiwicHVzaCIsIl8iLCJpc0Z1bmN0aW9uIiwiZ2V0T3duUHJvcGVydHlTeW1ib2xzIiwiX2dldFNpemVPZk9iamVjdCIsInNlZW4iLCJvYmplY3QiLCJpc05pbCIsImJ5dGVzIiwicHJvcGVydGllcyIsImtleSIsImhhcyIsImFkZCIsImdldENhbGN1bGF0b3IiLCJleCIsIlJhbmdlRXJyb3IiLCJjYWxjdWxhdG9yIiwiaXNCdWZmZXIiLCJsZW5ndGgiLCJTeW1ib2wiLCJrZXlGb3IiLCJ0b1N0cmluZyIsImlzQXJyYXkiLCJtYXAiLCJyZWR1Y2UiLCJhY2MiLCJjdXJyIiwiZ2V0T2JqZWN0U2l6ZSIsIldlYWtTZXQiLCJPQkpFQ1RTX01BUFBJTkciLCJXZWFrTWFwIiwiZ2V0T2JqZWN0SWQiLCJzZXQiLCJ1dWlkVjQiLCJnZXQiLCJkZWVwRnJlZXplIiwicHJvcE5hbWVzIiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsImlnbiIsIm5hbWUiLCJ2YWx1ZSJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9ub2RlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7aXNXaW5kb3dzfSBmcm9tICcuL3N5c3RlbSc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge2V4ZWN9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7djQgYXMgdXVpZFY0fSBmcm9tICd1dWlkJztcblxuY29uc3QgRUNNQV9TSVpFUyA9IE9iamVjdC5mcmVlemUoe1xuICBTVFJJTkc6IDIsXG4gIEJPT0xFQU46IDQsXG4gIE5VTUJFUjogOCxcbn0pO1xuXG4vKipcbiAqIEludGVybmFsIHV0aWxpdHkgdG8gbGluayBnbG9iYWwgcGFja2FnZSB0byBsb2NhbCBjb250ZXh0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhY2thZ2VOYW1lIC0gbmFtZSBvZiB0aGUgcGFja2FnZSB0byBsaW5rXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGNvbW1hbmQgZmFpbHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gbGlua0dsb2JhbFBhY2thZ2UocGFja2FnZU5hbWUpIHtcbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYExpbmtpbmcgcGFja2FnZSAnJHtwYWNrYWdlTmFtZX0nYCk7XG4gICAgY29uc3QgY21kID0gaXNXaW5kb3dzKCkgPyAnbnBtLmNtZCcgOiAnbnBtJztcbiAgICBhd2FpdCBleGVjKGNtZCwgWydsaW5rJywgcGFja2FnZU5hbWVdLCB7dGltZW91dDogMjAwMDB9KTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgY29uc3QgbXNnID0gYFVuYWJsZSB0byBsb2FkIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9JywgbGlua2luZyBmYWlsZWQ6ICR7ZXJyLm1lc3NhZ2V9YDtcbiAgICBsb2cuZGVidWcobXNnKTtcbiAgICBpZiAoZXJyLnN0ZGVycikge1xuICAgICAgLy8gbG9nIHRoZSBzdGRlcnIgaWYgdGhlcmUsIGJ1dCBkbyBub3QgYWRkIHRvIHRocm93biBlcnJvciBhcyBpdCBpc1xuICAgICAgLy8gX3ZlcnlfIHZlcmJvc2VcbiAgICAgIGxvZy5kZWJ1ZyhlcnIuc3RkZXJyKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gIH1cbn1cblxuLyoqXG4gKiBVdGlsaXR5IGZ1bmN0aW9uIHRvIGV4dGVuZCBub2RlIGZ1bmN0aW9uYWxpdHksIGFsbG93aW5nIHVzIHRvIHJlcXVpcmVcbiAqIG1vZHVsZXMgdGhhdCBhcmUgaW5zdGFsbGVkIGdsb2JhbGx5LiBJZiB0aGUgcGFja2FnZSBjYW5ub3QgYmUgcmVxdWlyZWQsXG4gKiB0aGlzIHdpbGwgYXR0ZW1wdCB0byBsaW5rIHRoZSBwYWNrYWdlIGFuZCB0aGVuIHJlLXJlcXVpcmUgaXRcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFja2FnZU5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgcGFja2FnZSB0byBiZSByZXF1aXJlZFxuICogQHJldHVybnMge1Byb21pc2U8dW5rbm93bj59IC0gdGhlIHBhY2thZ2Ugb2JqZWN0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBhY2thZ2UgaXMgbm90IGZvdW5kIGxvY2FsbHkgb3IgZ2xvYmFsbHlcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVxdWlyZVBhY2thZ2UocGFja2FnZU5hbWUpIHtcbiAgLy8gZmlyc3QsIGdldCBpdCBpbiB0aGUgbm9ybWFsIHdheSAoc2VlIGh0dHBzOi8vbm9kZWpzLm9yZy9hcGkvbW9kdWxlcy5odG1sI21vZHVsZXNfYWxsX3RvZ2V0aGVyKVxuICB0cnkge1xuICAgIGxvZy5kZWJ1ZyhgTG9hZGluZyBsb2NhbCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSdgKTtcbiAgICByZXR1cm4gcmVxdWlyZShwYWNrYWdlTmFtZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhgRmFpbGVkIHRvIGxvYWQgbG9jYWwgcGFja2FnZSAnJHtwYWNrYWdlTmFtZX0nOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgLy8gc2Vjb25kLCBnZXQgaXQgZnJvbSB3aGVyZSBpdCBvdWdodCB0byBiZSBpbiB0aGUgZ2xvYmFsIG5vZGVfbW9kdWxlc1xuICB0cnkge1xuICAgIGNvbnN0IGdsb2JhbFBhY2thZ2VOYW1lID0gcGF0aC5yZXNvbHZlKFxuICAgICAgcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19wcmVmaXggPz8gJycsXG4gICAgICAnbGliJyxcbiAgICAgICdub2RlX21vZHVsZXMnLFxuICAgICAgcGFja2FnZU5hbWVcbiAgICApO1xuICAgIGxvZy5kZWJ1ZyhgTG9hZGluZyBnbG9iYWwgcGFja2FnZSAnJHtnbG9iYWxQYWNrYWdlTmFtZX0nYCk7XG4gICAgcmV0dXJuIHJlcXVpcmUoZ2xvYmFsUGFja2FnZU5hbWUpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYEZhaWxlZCB0byBsb2FkIGdsb2JhbCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyB0aGlyZCwgbGluayB0aGUgZmlsZSBhbmQgZ2V0IGxvY2FsbHlcbiAgdHJ5IHtcbiAgICBhd2FpdCBsaW5rR2xvYmFsUGFja2FnZShwYWNrYWdlTmFtZSk7XG4gICAgbG9nLmRlYnVnKGBSZXRyeWluZyBsb2FkIG9mIGxpbmtlZCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSdgKTtcbiAgICByZXR1cm4gcmVxdWlyZShwYWNrYWdlTmFtZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBVbmFibGUgdG8gbG9hZCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZXh0cmFjdEFsbFByb3BlcnRpZXMob2JqKSB7XG4gIGNvbnN0IHN0cmluZ1Byb3BlcnRpZXMgPSBbXTtcbiAgZm9yIChjb25zdCBwcm9wIGluIG9iaikge1xuICAgIHN0cmluZ1Byb3BlcnRpZXMucHVzaChwcm9wKTtcbiAgfVxuICBpZiAoXy5pc0Z1bmN0aW9uKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpKSB7XG4gICAgc3RyaW5nUHJvcGVydGllcy5wdXNoKC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMob2JqKSk7XG4gIH1cbiAgcmV0dXJuIHN0cmluZ1Byb3BlcnRpZXM7XG59XG5cbmZ1bmN0aW9uIF9nZXRTaXplT2ZPYmplY3Qoc2Vlbiwgb2JqZWN0KSB7XG4gIGlmIChfLmlzTmlsKG9iamVjdCkpIHtcbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIGxldCBieXRlcyA9IDA7XG4gIGNvbnN0IHByb3BlcnRpZXMgPSBleHRyYWN0QWxsUHJvcGVydGllcyhvYmplY3QpO1xuICBmb3IgKGNvbnN0IGtleSBvZiBwcm9wZXJ0aWVzKSB7XG4gICAgLy8gRG8gbm90IHJlY2FsY3VsYXRlIGNpcmN1bGFyIHJlZmVyZW5jZXNcbiAgICBpZiAodHlwZW9mIG9iamVjdFtrZXldID09PSAnb2JqZWN0JyAmJiAhXy5pc05pbChvYmplY3Rba2V5XSkpIHtcbiAgICAgIGlmIChzZWVuLmhhcyhvYmplY3Rba2V5XSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBzZWVuLmFkZChvYmplY3Rba2V5XSk7XG4gICAgfVxuXG4gICAgYnl0ZXMgKz0gZ2V0Q2FsY3VsYXRvcihzZWVuKShrZXkpO1xuICAgIHRyeSB7XG4gICAgICBieXRlcyArPSBnZXRDYWxjdWxhdG9yKHNlZW4pKG9iamVjdFtrZXldKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgaWYgKGV4IGluc3RhbmNlb2YgUmFuZ2VFcnJvcikge1xuICAgICAgICAvLyBjaXJjdWxhciByZWZlcmVuY2UgZGV0ZWN0ZWQsIGZpbmFsIHJlc3VsdCBtaWdodCBiZSBpbmNvcnJlY3RcbiAgICAgICAgLy8gbGV0J3MgYmUgbmljZSBhbmQgbm90IHRocm93IGFuIGV4Y2VwdGlvblxuICAgICAgICBieXRlcyA9IDA7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGJ5dGVzO1xufVxuXG5mdW5jdGlvbiBnZXRDYWxjdWxhdG9yKHNlZW4pIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIGNhbGN1bGF0b3Iob2JqKSB7XG4gICAgaWYgKF8uaXNCdWZmZXIob2JqKSkge1xuICAgICAgcmV0dXJuIG9iai5sZW5ndGg7XG4gICAgfVxuXG4gICAgc3dpdGNoICh0eXBlb2Ygb2JqKSB7XG4gICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICByZXR1cm4gb2JqLmxlbmd0aCAqIEVDTUFfU0laRVMuU1RSSU5HO1xuICAgICAgY2FzZSAnYm9vbGVhbic6XG4gICAgICAgIHJldHVybiBFQ01BX1NJWkVTLkJPT0xFQU47XG4gICAgICBjYXNlICdudW1iZXInOlxuICAgICAgICByZXR1cm4gRUNNQV9TSVpFUy5OVU1CRVI7XG4gICAgICBjYXNlICdzeW1ib2wnOlxuICAgICAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKFN5bWJvbC5rZXlGb3IpICYmIFN5bWJvbC5rZXlGb3Iob2JqKVxuICAgICAgICAgID8gLyoqIEB0eXBlIHtzdHJpbmd9ICovIChTeW1ib2wua2V5Rm9yKG9iaikpLmxlbmd0aCAqIEVDTUFfU0laRVMuU1RSSU5HXG4gICAgICAgICAgOiAob2JqLnRvU3RyaW5nKCkubGVuZ3RoIC0gOCkgKiBFQ01BX1NJWkVTLlNUUklORztcbiAgICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAgIHJldHVybiBfLmlzQXJyYXkob2JqKVxuICAgICAgICAgID8gb2JqLm1hcChnZXRDYWxjdWxhdG9yKHNlZW4pKS5yZWR1Y2UoKGFjYywgY3VycikgPT4gYWNjICsgY3VyciwgMClcbiAgICAgICAgICA6IF9nZXRTaXplT2ZPYmplY3Qoc2Vlbiwgb2JqKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfTtcbn1cblxuLyoqXG4gKiBDYWxjdWxhdGUgdGhlIGluLWRlcHRoIHNpemUgaW4gbWVtb3J5IG9mIHRoZSBwcm92aWRlZCBvYmplY3QuXG4gKiBUaGUgb3JpZ2luYWwgaW1wbGVtZW50YXRpb24gaXMgYm9ycm93ZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vbWlrdGFtL3NpemVvZi5cbiAqXG4gKiBAcGFyYW0geyp9IG9iaiBBbiBvYmplY3Qgd2hvc2Ugc2l6ZSBzaG91bGQgYmUgY2FsY3VsYXRlZFxuICogQHJldHVybnMge251bWJlcn0gT2JqZWN0IHNpemUgaW4gYnl0ZXMuXG4gKi9cbmZ1bmN0aW9uIGdldE9iamVjdFNpemUob2JqKSB7XG4gIHJldHVybiBnZXRDYWxjdWxhdG9yKG5ldyBXZWFrU2V0KCkpKG9iaik7XG59XG5cbmNvbnN0IE9CSkVDVFNfTUFQUElORyA9IG5ldyBXZWFrTWFwKCk7XG5cbi8qKlxuICogQ2FsY3VsYXRlcyBhIHVuaXF1ZSBvYmplY3QgaWRlbnRpZmllclxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgQW55IHZhbGlkIEVDTUEgb2JqZWN0XG4gKiBAcmV0dXJucyB7c3RyaW5nfSBBIHV1aWRWNCBzdHJpbmcgdGhhdCB1bmlxdWVseSBpZGVudGlmaWVzIGdpdmVuIG9iamVjdFxuICovXG5mdW5jdGlvbiBnZXRPYmplY3RJZChvYmplY3QpIHtcbiAgaWYgKCFPQkpFQ1RTX01BUFBJTkcuaGFzKG9iamVjdCkpIHtcbiAgICBPQkpFQ1RTX01BUFBJTkcuc2V0KG9iamVjdCwgdXVpZFY0KCkpO1xuICB9XG4gIHJldHVybiBPQkpFQ1RTX01BUFBJTkcuZ2V0KG9iamVjdCk7XG59XG5cbi8qKlxuICogUGVyZm9ybSBkZWVwIGZyZWV6ZSBvZiB0aGUgZ2l2ZW4gb2JqZWN0IChlLiBnLlxuICogYWxsIG5lc3RlZCBvYmplY3RzIGFsc28gYmVjb21lIGltbXV0YWJsZSkuXG4gKiBJZiB0aGUgcGFzc2VkIG9iamVjdCBpcyBvZiBhIHBsYWluIHR5cGVcbiAqIHRoZW4gbm8gY2hhbmdlIGlzIGRvbmUgYW5kIHRoZSBzYW1lIG9iamVjdFxuICogaXMgcmV0dXJuZWQuXG4gKiAhIFRoaXMgZnVuY3Rpb24gY2hhbmdlcyB0aGUgZ2l2ZW4gb2JqZWN0LFxuICogc28gaXQgYmVjb21lcyBpbW11dGFibGUuXG4gKlxuICogQHBhcmFtIHsqfSBvYmplY3QgQW55IHZhbGlkIEVDTUEgb2JqZWN0XG4gKiBAcmV0dXJucyB7Kn0gVGhlIHNhbWUgb2JqZWN0IHRoYXQgd2FzIHBhc3NlZCB0byB0aGVcbiAqIGZ1bmN0aW9uIGFmdGVyIGl0IHdhcyBtYWRlIGltbXV0YWJsZS5cbiAqL1xuZnVuY3Rpb24gZGVlcEZyZWV6ZShvYmplY3QpIHtcbiAgbGV0IHByb3BOYW1lcztcbiAgdHJ5IHtcbiAgICBwcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhvYmplY3QpO1xuICB9IGNhdGNoIChpZ24pIHtcbiAgICByZXR1cm4gb2JqZWN0O1xuICB9XG4gIGZvciAoY29uc3QgbmFtZSBvZiBwcm9wTmFtZXMpIHtcbiAgICBjb25zdCB2YWx1ZSA9IG9iamVjdFtuYW1lXTtcbiAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgZGVlcEZyZWV6ZSh2YWx1ZSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBPYmplY3QuZnJlZXplKG9iamVjdCk7XG59XG5cbmV4cG9ydCB7cmVxdWlyZVBhY2thZ2UsIGdldE9iamVjdFNpemUsIGdldE9iamVjdElkLCBkZWVwRnJlZXplfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxVQUFVLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0VBQy9CQyxNQUFNLEVBQUUsQ0FEdUI7RUFFL0JDLE9BQU8sRUFBRSxDQUZzQjtFQUcvQkMsTUFBTSxFQUFFO0FBSHVCLENBQWQsQ0FBbkI7O0FBWUEsZUFBZUMsaUJBQWYsQ0FBaUNDLFdBQWpDLEVBQThDO0VBQzVDLElBQUk7SUFDRkMsZUFBQSxDQUFJQyxLQUFKLENBQVcsb0JBQW1CRixXQUFZLEdBQTFDOztJQUNBLE1BQU1HLEdBQUcsR0FBRyxJQUFBQyxpQkFBQSxNQUFjLFNBQWQsR0FBMEIsS0FBdEM7SUFDQSxNQUFNLElBQUFDLGtCQUFB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